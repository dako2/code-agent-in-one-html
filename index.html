<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Gemini Agent</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>body,html{height:100%;margin:0;font:13px monospace;display:flex;flex-direction:column}*{box-sizing:border-box}button,input,textarea{border:1px solid #e5e7eb;background:#fff;border-radius:6px;padding:.35rem .55rem;font:inherit}button{cursor:pointer}label{display:flex;align-items:center;gap:.35rem}.m{margin:.35rem 0;padding:.45rem .6rem;border:1px solid #e5e7eb;border-radius:8px;white-space:pre-wrap;word-break:break-word}a{color:#2563eb}</style>
</head>
<body style="font-family:ui-monospace,monospace">

<header style="display:flex;gap:.5rem;align-items:center;padding:.5rem;border-bottom:1px solid #e5e7eb;background:#fafafa;flex-wrap:wrap">
  <input id="k" type="password" placeholder="Google AI API Key" style="min-width:240px">
  <button id="S">Send</button>
  <label><input id="mo" type="checkbox" checked>ðŸ§ <small id="ms">(0)</small></label>
  <button id="C">Clear</button>
  <input type="file" id="fi" style="display:none">
  <button id="L">Load</button>
  <textarea id="s" style="width:100%;margin-top:5px;height:40px;resize:vertical">You are a coding assistant. Wrap final code in a markdown block like ```language\n...code...\n```</textarea>
</header>

<div style="flex:1;display:grid;grid-template-rows:1fr 35vh;overflow:hidden">
  <textarea id="e" placeholder="Generated code will appear hereâ€¦" spellcheck="false" style="border:0;border-bottom:1px solid #e5e7eb;padding:10px;resize:none;outline:none"></textarea>
  <div style="display:flex;flex-direction:column;overflow:hidden">
    <div id="c" style="flex:1;overflow:auto;padding:8px"></div>
    <textarea id="p" placeholder="Ask Gemini to write or modify codeâ€¦" style="min-height:60px;resize:vertical;border-bottom:0;border-radius:6px 6px 0 0"></textarea>
    <div style="padding:.25rem .6rem;text-align:right;font-size:11px;color:#6b7280;background:#fafafa;border-top:1px solid #e5e7eb;border-radius:0 0 6px 6px">âŒ˜/Ctrl+Enter</div>
  </div>
</div>

<script type="module">
import { GoogleGenerativeAI as G } from 'https://esm.run/@google/generative-ai';
const $ = q => document.querySelector(q);
const K = 'g_mem_v2';
const A = (c, t, h) => {
  const d=document.createElement('div');
  d.className=`m ${c}`;
  d[h?'innerHTML':'textContent']=t;
  $('#c').appendChild(d);
  $('#c').scrollTop = $('#c').scrollHeight;
};
const m = {
  f:[],t:[],
  sv(){sessionStorage.setItem(K,JSON.stringify({f:this.f,t:this.t.slice(-20)}));$('#ms').textContent=`(${this.f.length+this.t.length})`},
  cl(){this.f=[];this.t=[];this.sv()},
  ad(t){(t=t.trim())&&this.f.push(t);this.sv()},
  rc(b=4e3){let p=this.f.length?['FACTS:\n'+this.f.map(f=>`- ${f}`).join('\n')]:[],u=p.join('\n\n').length;for(const t of this.t){const s=`Q: ${t.q}\nA: ${t.a}`;if(u+s.length>b)break;p.push(s);u+=s.length}return p.join('\n\n')}
};
const S = async () => {
  const q = $('#p').value.trim();
  if (!q) return;
  A('me', q);
  $('#p').value = '';
  if (q.startsWith('/remember ')){return m.ad(q.slice(10)),A('bot','âœ… Remembered.')}
  if (q==='/mem'){return A('bot',m.rc(8e3)||'(empty)')}
  if (q==='/clear-mem'){return m.cl(),A('bot','ðŸ§¹ Cleared.')}
  try {
    const k=$('#k').value.trim(); if(!k)throw new Error('API key required.');
    const model=new G(k).getGenerativeModel({model:'gemini-2.5-flash'});
    const T=`${$('#s').value}\n\nCONTEXT:\n---\n${$('#e').value.slice(0,12e3)}\n---\n\nMEMORY:\n---\n${m.rc()||'(none)'}\n---\n\nQUESTION:\n${q}`;
    const r=await model.generateContent({contents:[{role:'user',parts:[{text:T}]}],generationConfig:{temperature:.3}});
    const a=r?.response?.text()||'(no response)';
    A('bot',a);
    const c=a.match(/```(?:[a-z]+\n)?([\s\S]*?)```/);
    if(c&&c[1]) $('#e').value=c[1].trim();
    if($('#mo').checked) m.t.push({q,a}),m.sv();
  } catch(e) { A('err',e?.message||'Request failed') }
};
const l=JSON.parse(sessionStorage.getItem(K)||"{}");m.f=l.f||[];m.t=l.t||[];m.sv();
$('#k').value=sessionStorage.getItem('g_api_key')||'';
$('#k').oninput=()=>sessionStorage.setItem('g_api_key',$('#k').value.trim());
$('#S').onclick=S;
$('#C').onclick=()=>{m.cl();A('bot','ðŸ§¹ Cleared.')};
$('#L').onclick=()=>$('#fi').click();
$('#fi').onchange=e=>{const f=e.target.files[0];if(f){const r=new FileReader();r.onload=e=>{$('#e').value=e.target.result;A('bot',`âœ… Loaded: ${f.name}`)};r.readAsText(f)}};
addEventListener('keydown',e=>{if((e.metaKey||e.ctrlKey)&&e.key==='Enter'){e.preventDefault();S()}});
A('bot','API key from <a href="https://aistudio.google.com/app/apikey" target="_blank">aistudio.google.com</a>',true);
</script>
</body>
</html>